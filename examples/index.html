<!DOCTYPE html>
<html>
  <head>
    <title>Leaflet.DistortableImage Example</title>
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script
      src="../node_modules/leaflet/dist/leaflet.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
    <link
      href="../node_modules/font-awesome/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="../node_modules/leaflet/dist/leaflet.css"
      type="text/css"
      media="screen"
      title="no title"
      charset="utf-8"
    />
    <script src="../node_modules/leaflet-toolbar/dist/leaflet.toolbar.js"></script>
    <link
      href="../node_modules/leaflet-toolbar/dist/leaflet.toolbar.css"
      rel="stylesheet"
    />

    <!-- for full-res export -->
    <script src="../node_modules/jquery/dist/jquery.js"></script>
    <script src="../node_modules/webgl-distort/dist/webgl-distort.js"></script>
    <script src="../node_modules/glfx/glfx.js"></script>

    <!-- for EXIF geocode -->
    <script
      type="text/javascript"
      src="../node_modules/exif-js/exif.js"
    ></script>

    <link
      rel="stylesheet"
      href="../dist/leaflet.distortableimage.css"
      type="text/css"
      media="screen"
      title="no title"
      charset="utf-8"
    />
    <script src="../dist/leaflet.distortableimage.js"></script>
  </head>
  <body style="margin:0;">
    <form id="test_form">
      <input type="file" id="inputimage" accept="image/*" />
    </form>

    <div
      id="map"
      style="width:100%; height:100%; position:absolute; top:0;"
    ></div>
  </body>
  <script>
    var map;

    (function() {
      // basic Leaflet map setup
      map = L.map("map").setView([51.505, -0.09], 13);
      L.tileLayer(
        "https://{s}.tiles.mapbox.com/v3/anishshah101.ipm9j6em/{z}/{x}/{y}.png",
        {
          maxZoom: 18,
          attribution:
            'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
          id: "examples.map-i86knfo3"
        }
      ).addTo(map);

      // create an image
      img = L.distortableImageOverlay("example.png", {
        // add a toolbarType field with values 'popup' (default) or 'control'
        // add a keymapper: false <== hides the keymapper
        // add a keymapper_position field with combinations of 'top', 'bottom', 'left' or 'right'
        selected: true,
        corners: [
          L.latLng(51.52, -0.1),
          L.latLng(51.52, -0.14),
          L.latLng(51.5, -0.1),
          L.latLng(51.5, -0.14)
        ],
        fullResolutionSrc: "large.jpg"
      }).addTo(map);

     

      /* add custom icon functionality */
      // refer this snippet below inorder to add a custom functionality

      //  var tool = EditOverlayAction.extend({
      //    options: {
      //      toolbarIcon: {
      //        html: '<span class="fa fa-plus-circle"></span>',
      //        tooltip: "Print a console message!",
      //        title: "Console logger"
      //      }
      //    },
      //
      //    addHooks: function() {
      //      var editing = this._overlay.editing;
      //      editing._demonstrator();
      //      this.disable();
      //    }
      //  });
      //
      // img._addTool(tool);

      L.DomEvent.on(img._image, "load", img.editing.enable, img.editing);
      
      var pos = img._image.getBoundingClientRect();
      var centerX = pos.left + pos.width / 2;
      var centerY = pos.top + pos.height / 2;
      var centerRadius = pos.width / 10;
      window.centerX = centerX;
      window.centerY = centerY;

      var touchInfo = { alpha: 0, radius: 0, down: false };

      var lastTouchAlpha = 0;

      function getXYFromTouchOrPointer(e) {
        window.ec = e;

        var x = e.clientX;
        var y = e.clientY;
        console.log({ x: x - centerX, y: y - centerY });
        return { x: x - centerX, y: y - centerY };
      }

      function onTouchStart(e) {
        console.log("made it");

        var { x, y } = getXYFromTouchOrPointer(e);
        console.log(x);
        console.log(y);
        // onTouchMove(e);
        touchInfo.down = true;
        // touchInfo.radius = Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2));
        var initialAngle = Math.atan2(centerY - y, centerX - x);
        window.initialAngle = initialAngle;
        onTouchMove(e);
        // lastTouchAlpha = touchInfo.alpha;
      }

      function onTouchMove(e) {
        console.log("made it2");

        var { x, y } = getXYFromTouchOrPointer(e);

        var newAngle = Math.atan2(centerY - y, centerX - x);
        window.newAngle = newAngle;
        var angle = window.newAngle - window.initialAngle;

        window.angle2 = angle;
        
        touchInfo.alpha = (Math.atan2(centerY - y, centerX - x) - initialAngle);
        window.f = touchInfo.alpha;
        e.preventDefault();
        img.editing._rotateBy(touchInfo.alpha);

        img.fire('update');
      }

      function touchEnd() {
        touchInfo.down = false;
      }

      L.DomEvent.on(img._image, "pointerdown", onTouchStart, img._image);
      L.DomEvent.on(img._image, "pointermove", onTouchMove, img._image);
      L.DomEvent.on(img._image, "pointerup touchend", touchEnd, img._image);
      L.DomEvent.on(img._image, "pointercancel touchcancel", touchEnd, img._image);
    })();
  </script>
</html>
