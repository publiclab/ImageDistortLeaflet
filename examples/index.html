<!DOCTYPE html>
<html>

<head>
  <title>Leaflet.DistortableImage Example</title>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="../node_modules/leaflet/dist/leaflet.js" type="text/javascript" charset="utf-8"></script>
  <link href="../node_modules/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../node_modules/leaflet/dist/leaflet.css" type="text/css" media="screen" title="no title"
    charset="utf-8" />
  <script src="../node_modules/leaflet-toolbar/dist/leaflet.toolbar.js"></script>
  <link href="../node_modules/leaflet-toolbar/dist/leaflet.toolbar.css" rel="stylesheet" />
  <!-- for pattern-mining utility -->
  <script src="../node_modules/matcher-core/orb.core.com.js"></script>

  <!-- for full-res export -->
  <script src="../node_modules/jquery/dist/jquery.js"></script>
  <script src="../node_modules/webgl-distort/dist/webgl-distort.js"></script>
  <script src="../node_modules/glfx/glfx.js"></script>

  <!-- for EXIF geocode -->
  <script type="text/javascript" src="../node_modules/exif-js/exif.js"></script>

  <link rel="stylesheet" href="../dist/leaflet.distortableimage.css" type="text/css" media="screen" title="no title"
    charset="utf-8" />
  <script src="../dist/leaflet.distortableimage.js"></script>
</head>

<body style="margin:0;">
  <form id="test_form">
    <input type="file" id="inputimage" accept="image/*" />
  </form>

  <div id="map" style="width:100%; height:100%; position:absolute; top:0;"></div>
</body>
<script>

  var map;
  var img2path = '../node_modules/matcher-core/assets/resources/small.jpg';
  var img1path = '../node_modules/matcher-core/assets/resources/big.jpg';

  // respective to origin
  function projector(utils, e, array, L_img_array, map) {
    document.querySelector("#map > div.leaflet-pane.leaflet-map-pane > div.leaflet-pane.leaflet-marker-pane").innerHTML = "";
    var match_points = utils.matches;
    var icon = L.icon({
      iconUrl: "dot.png",
      iconSize: [4, 4],
      iconAnchor: [2, 2],
      popupAnchor: [2, 2]
    });
    var dot = (x, y, c) => L.marker([x, y], { icon: icon }).addTo(map).bindPopup(JSON.stringify(c));
    array.push(e.target);
    if (array.length >= 2) {
      array = array.slice(-2);
      // client
      var A = array[0];
      var B = array[1];
      // L objects
      for (i in L_img_array) {
        if (L_img_array[i]._image == A) {
          array[0] = L_img_array[i];
        }
        if (L_img_array[i]._image == B) {
          array[1] = L_img_array[i];
        }
      }
      var idx = 2;
      var processedPoints = {points: [], images: []};
      for (i in array) {
        var wA = A.clientWidth, hA = A.clientHeight;
        var h_diff = Math.abs(map.latLngToContainerPoint(array[i].getCorner(0)).x - map.latLngToContainerPoint(array[i].getCorner(1)).x);
        var rwA = h_diff / wA;
        var v_diff = Math.abs(map.latLngToContainerPoint(array[i].getCorner(0)).y - map.latLngToContainerPoint(array[i].getCorner(2)).y);
        var rhA = v_diff / hA;
        var temp = [];
        for (m of match_points) {
          var t1 = eval(`m.x${idx}`);
          var t2 = eval(`m.y${idx}`);
          var confidence = eval(`m.confidence.c${idx}`);
          var x_off = t1 * rwA;
          var y_off = t2 * rhA;
          var x_plot = map.latLngToContainerPoint(array[i].getCorner(0)).x - x_off;
          var y_plot = map.latLngToContainerPoint(array[i].getCorner(0)).y + y_off;
          temp.push([x_plot, y_plot]);
        }
        processedPoints.images.push(array[i]);
        processedPoints.points[i] = [];
        for (n in temp) {
          var k = map.containerPointToLatLng(temp[n]);
          processedPoints.points[i].push(k);
          dot(k.lat, k.lng, confidence);
        }
        // swap for second iteration
        A = B;
        idx--;
      }
      window.processedPoints = processedPoints;
    }
  }

  Promise.resolve(new orbify(img1path, img2path, {
    browser: true
  }).utils).then(function (utils) {
    init(utils);
  })

  function init(utils) {
    map = L.map("map").setView([51.505, -0.09], 12);
    L.tileLayer(
      "https://{s}.tiles.mapbox.com/v3/anishshah101.ipm9j6em/{z}/{x}/{y}.png",
      {
        maxZoom: 18,
        id: "examples.map-i86knfo3"
      }
    ).addTo(map);

    img1 = L.distortableImageOverlay(img1path, {
      selected: true,
      corners: [
        L.latLng(51.52, -0.1),
        L.latLng(51.52, -0.14),
        L.latLng(51.5, -0.1),
        L.latLng(51.5, -0.14)
      ],
      fullResolutionSrc: "large.jpg"
    }).addTo(map);

    img2 = L.distortableImageOverlay(img2path, {
      selected: true,
      corners: [
        L.latLng(51.52, -0.14),
        L.latLng(51.52, -0.18),
        L.latLng(51.5, -0.14),
        L.latLng(51.5, -0.18)
      ],
      fullResolutionSrc: "large.jpg"
    }).addTo(map);
    
    img3 = L.distortableImageOverlay(img1path, {
      selected: true,
      corners: [
        L.latLng(51.52, -0.14),
        L.latLng(51.52, -0.18),
        L.latLng(51.5, -0.14),
        L.latLng(51.5, -0.18)
      ],
      fullResolutionSrc: "large.jpg"
    }).addTo(map);

    L.DomEvent.on(img1._image, "load", img1.editing.enable, img1.editing);
    L.DomEvent.on(img2._image, "load", img2.editing.enable, img2.editing);
    L.DomEvent.on(img3._image, "load", img3.editing.enable, img3.editing);

    var images = document.getElementsByClassName('leaflet-image-layer leaflet-zoom-animated');
    var array = [];
    // x1 x2
    var L_img_array = [img1, img2, img3];
    for (i of images) {
      i.addEventListener('click', function (e) {
        // define orb inside this
        projector(utils, e, array, L_img_array, map);
      })
    }
  }

</script>

</html>
