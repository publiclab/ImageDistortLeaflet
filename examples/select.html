<!DOCTYPE html>
<html>
<head>
  <title>Leaflet.DistortableImage Example</title>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="../node_modules/leaflet/dist/leaflet-src.js" type="text/javascript" charset="utf-8"></script>
  <link href="../node_modules/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../node_modules/leaflet/dist/leaflet.css" type="text/css" media="screen" title="no title" charset="utf-8">
  <script src="../node_modules/leaflet-toolbar/dist/leaflet.toolbar.js"></script>
  <link href="../node_modules/leaflet-toolbar/dist/leaflet.toolbar.css" rel="stylesheet"/>

  <!-- for full-res export -->
  <script src="../node_modules/jquery/dist/jquery.js"></script>
  <script src="../node_modules/webgl-distort/dist/webgl-distort.js"></script>
  <script src="../node_modules/glfx/glfx.js"></script>

  <link rel="stylesheet" href="../dist/leaflet.distortableimage.css" type="text/css" media="screen" title="no title" charset="utf-8">
  <script src="../dist/leaflet.distortableimage.js"></script>
  <style>
    img.leaflet-image-layer.selected {
      box-shadow: 0px 0px 0px 12px rgb(255, 0, 106);
    }
  </style>
</head>
<body style="margin:0;">

  <form id="test_form" >
    <input type="file" id="inputimage" accept="image/*">
  </form>

  <div id="map" style="width:100%; height:100%; position:absolute; top:0;"></div>

  <script>

    var map

    (function(){

      // basic Leaflet map setup
      map = new L.map('map').setView([51.505, -0.09], 13);
      L.tileLayer('https://{s}.tiles.mapbox.com/v3/anishshah101.ipm9j6em/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
          '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
          'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        id: 'examples.map-i86knfo3'
      }).addTo(map);

      images = []
      select = function(e){
        for (var i in images) {
          img = this
          if (img._leaflet_id != images[i]._leaflet_id) {
            /* Deselect (disable) other images */
            // images[i].editing.disable()
            /* Ensure that other toolbars are removed */
            if (images[i].editing.toolbar) {
              map.removeLayer(images[i].editing.toolbar);
            }
          }
        }
        /* Ensure this is enabled */
        this.editing.enable()
        /* If it's locked, allow event to propagate on to map below */
        if (this.editing._mode != "lock") e.stopPropagation()
      }

      // create an image
      img = new L.DistortableImageOverlay(
        'example.png', {
          corners: [
            new L.latLng(51.52,-0.10),
            new L.latLng(51.52,-0.14),
            new L.latLng(51.50,-0.10),
            new L.latLng(51.50,-0.14)
          ],
          mode: 'lock'
        }
      ).addTo(map);
      images.push(img)
      // L.DomEvent.on(img._image, 'click', select, img);

      // create a second image
      img2 = new L.DistortableImageOverlay(
        'example.png', {
          corners: [
            new L.latLng(51.51,-0.10),
            new L.latLng(51.51,-0.14),
            new L.latLng(51.49,-0.11),
            new L.latLng(51.49,-0.15)
          ]
        }
      ).addTo(map);

      images.push(img2);

      window.img = img;
      window.img2 = img2;

      // var bounds2 = new L.LatLngBounds(new L.LatLng(51.40, -0.10), new L.LatLng(51.55, -0.15));
      // var div = document.createElement("div");
      // div.id = "fooo";
      // div.style.background = "rgba(255,255,255,0.5)";
      // div.innerHTML = "<h3>This is a div element</h3> in an element overlay";
      // layer2 = L.elementOverlay(
      //   div, {
      //   corners: [
      //     new L.latLng(51.40, -0.10),
      //     new L.latLng(51.40, -0.15),
      //     new L.latLng(51.47, -0.11),
      //     new L.latLng(51.47, -0.16)
      //   ],
      // }
      // ).addTo(map);
      // images.push(layer2);
      // window.layer2 = layer2;

      // L.DomEvent.on(img._image, 'load', img.editing.enable, img.editing);
      // L.DomEvent.on(img2._image, 'load', img2.editing.enable, img2.editing);
      // L.DomEvent.on(img2._image, 'click', select, img2);

      map.on('click', function () {
        $('.selected').removeClass('selected');
      });

      L.DomEvent.on(img._image, 'mousedown', function (e) {
        if (e.metaKey || e.ctrlKey)
          $(e.target).toggleClass('selected');
      });

      L.DomEvent.on(img2._image, 'mousedown', function (e) {
        if (e.metaKey || e.ctrlKey)
          $(e.target).toggleClass('selected');
      });

      // img2 is on the left (or initially bottom) img is on the right

      let obj = {};
      let objC = {};
      let obj2 = {};
      let objD = {};
      
      obj.initVal = 0;
      obj.initVal1 = 0;
      obj.initVal2 = 0;
      obj.initVal3 = 0;

      obj2.initVal = 0;
      obj2.initVal1 = 0;
      obj2.initVal2 = 0;
      obj2.initVal3 = 0;


      L.DomEvent.on(img, 'dragstart', function (e) {
        //console.log('dragstart initial lat: ', img._corners[0].lat);
        let i = 0
        for (let k in obj) {
            obj[k] = map.latLngToLayerPoint(img.getCorners()[i]);
            obj2[k] = map.latLngToLayerPoint(img2.getCorners()[i]);
            i += 1;
        }
        console.log('Initial: ', obj);
        window.obj = obj;
    
      });
      
      L.DomEvent.on(img, 'drag', function (e) {
        //console.log('dragging changing lat: ', img._corners[0].lat);
        objC.changes = obj.initVal.x -  map.latLngToLayerPoint(img.getCorners()[0]).x;
        objC.changes1 = obj.initVal.y -  map.latLngToLayerPoint(img.getCorners()[0]).y;

        objC.changes2 = obj.initVal1.x -  map.latLngToLayerPoint(img.getCorners()[1]).x;
        objC.changes3 = obj.initVal1.y -  map.latLngToLayerPoint(img.getCorners()[1]).y;

        objC.changes4 = obj.initVal2.x -  map.latLngToLayerPoint(img.getCorners()[2]).x;
        objC.changes5 = obj.initVal2.y -  map.latLngToLayerPoint(img.getCorners()[2]).y;

        objC.changes6 = obj.initVal3.x -  map.latLngToLayerPoint(img.getCorners()[3]).x;
        objC.changes7 = obj.initVal3.y -  map.latLngToLayerPoint(img.getCorners()[3]).y;

        window.objC = objC;
        console.log('Changes: ', objC);

         
        objD.newVal = L.point([obj2.initVal.x - objC.changes, obj2.initVal.y - objC.changes1]);
        objD.newVal1 = L.point([obj2.initVal1.x - objC.changes2, obj2.initVal1.y - objC.changes3]);
        objD.newVal2 = L.point([obj2.initVal2.x - objC.changes4, obj2.initVal2.y - objC.changes5]);
        objD.newVal3 = L.point([obj2.initVal3.x - objC.changes6, obj2.initVal3.y - objC.changes7]);

        let i = 0;
        for (let k in objD) {
          img2.getCorners()[i].lat = map.layerPointToLatLng(objD[k]).lat;
          img2.getCorners()[i].lng = map.layerPointToLatLng(objD[k]).lng;
          i += 1;
        }

        console.log('New: ', obj2);
        window.obj2 = obj2;

        img2._reset();

        img2.fire('update');
        map.fire('update');
        
      });

      L.DomEvent.on(img._image, 'load', img.editing.enable, img.editing);
      L.DomEvent.on(img2._image, 'load', img2.editing.enable, img2.editing);
      // L.DomEvent.on(layer2._image, 'load', layer2.editing.enable, layer2.editing);

      // this doesn't work -- it triggers when clicking toolbar
      // can we stopPropagation of toolbar clicks? is that impolite.
      map.on('mousedown', function() {
        for (var i in images) {
          /* Deselect (disable) all images */
          //images[i].editing.disable()
          /* Remove toolbars */
          if (images[i].editing.toolbar) {
            //map.removeLayer(images[i].editing.toolbar);
          }
        }
      });

    })();
  </script>

  

</html>
